{% extends 'games/base.html' %}
{% block title %}Live & Upcoming | BGSC Leagues{% endblock %}
{% block content %}
  <h1>Live Games</h1>

  <h2>Live Now</h2>
  {% if live_games %}
    {% for item in live_games %}
      {% with g=item.game %}
      <div class="card" id="game-{{ g.id }}" data-sport="{{ g.sport }}">
        <div class="spaced">
          <div><strong>{{ g.get_sport_display }}</strong> — {{ g.team1.name }} vs {{ g.team2.name }}</div>
          <span class="badge">{{ g.status }}</span>
        </div>
        <div class="subtle">Kickoff: {{ g.scheduled_time }}</div>

        {% if item.type == 'football' %}
          <div class="row">
            <div>
              <h3>{{ g.team1.name }} — <span class="score">{{ item.team1_score }}</span></h3>
              <div>Top Scorer: {% if item.team1_top %}{{ item.team1_top.player.name }} ({{ item.team1_top.points }}){% else %}-{% endif %}</div>
              <div>Last Scorer: {% if item.team1_last %}{{ item.team1_last.player.name }} (total {{ item.team1_last_pts|default:0 }}){% else %}-{% endif %}</div>
            </div>
            <div>
              <h3>{{ g.team2.name }} — <span class="score">{{ item.team2_score }}</span></h3>
              <div>Top Scorer: {% if item.team2_top %}{{ item.team2_top.player.name }} ({{ item.team2_top.points }}){% else %}-{% endif %}</div>
              <div>Last Scorer: {% if item.team2_last %}{{ item.team2_last.player.name }} (total {{ item.team2_last_pts|default:0 }}){% else %}-{% endif %}</div>
            </div>
          </div>
        {% elif item.type == 'basketball' %}
          <div class="row">
            <div>
              <h3>{{ g.team1.name }} — <span class="score">{{ item.team1_score }}</span></h3>
              <div class="table-wrap"><table>
                <thead><tr><th>Player</th><th>Pts</th></tr></thead>
                <tbody>
                  {% for ps in item.team1_players %}
                  <tr><td>{{ ps.player.name }}</td><td>{{ ps.points }}</td></tr>
                  {% endfor %}
                </tbody>
              </table></div>
            </div>
            <div>
              <h3>{{ g.team2.name }} — <span class="score">{{ item.team2_score }}</span></h3>
              <div class="table-wrap"><table>
                <thead><tr><th>Player</th><th>Pts</th></tr></thead>
                <tbody>
                  {% for ps in item.team2_players %}
                  <tr><td>{{ ps.player.name }}</td><td>{{ ps.points }}</td></tr>
                  {% endfor %}
                </tbody>
              </table></div>
            </div>
          </div>
        {% elif item.type == 'cricket' %}
          <div>
            <h3>Batting: {{ item.batting_team.name }} — <span class="score">{{ item.team_runs }}</span></h3>
            <div>Current Batsman: {% if item.batsman %}{{ item.batsman.name }} ({{ item.batsman_runs }} runs){% else %}-{% endif %}</div>
            <div>Current Bowler: {% if item.bowler %}{{ item.bowler.name }} ({{ item.bowler_wickets }} wickets){% else %}-{% endif %}</div>
          </div>
        {% endif %}
      </div>
      {% endwith %}
    {% endfor %}
  {% else %}
    <div class="card">No games live right now.</div>
  {% endif %}

  <h2 class="section-title">Upcoming</h2>
  {% if upcoming %}
    {% for g in upcoming %}
      <div class="card">
        <div><strong>{{ g.get_sport_display }}</strong> — {{ g.team1.name }} vs {{ g.team2.name }}</div>
        <small>Starts: {{ g.scheduled_time }}</small>
      </div>
    {% endfor %}
  {% else %}
    <div class="card">No upcoming games scheduled.</div>
  {% endif %}
  
  <script>
    (function() {
      var ws;
      var retries = 0;
      var maxRetries = 10;
      var lastActivity = Date.now();
      var wasHidden = false;

      function connect() {
        try {
          var proto = window.location.protocol === 'https:' ? 'wss' : 'ws';
          ws = new WebSocket(proto + '://' + window.location.host + '/ws/live/');
          
          ws.onopen = function() {
            retries = 0;
            lastActivity = Date.now();
            console.debug('[live] connected');
          };
          
          ws.onmessage = function(ev) {
            lastActivity = Date.now();
            try {
              var msg = JSON.parse(ev.data || '{}');
              if (msg && (msg.kind === 'score_update' || msg.kind === 'undo' || msg.kind === 'status_change' || msg.kind === 'state_update')) {
                window.location.reload();
              }
            } catch (e) {
              window.location.reload();
            }
          };
          
          ws.onclose = function() {
            console.debug('[live] connection closed');
            if (retries < maxRetries) {
              var backoff = Math.min(1000 * Math.pow(2, retries++), 10000);
              setTimeout(connect, backoff);
            }
          };
          
          ws.onerror = function() {
            console.debug('[live] connection error');
            try { ws.close(); } catch (e) {}
          };
        } catch (e) {
          console.debug('[live] connection failed:', e);
        }
      }

      // Handle mobile browser backgrounding/foregrounding
      function handleVisibilityChange() {
        if (document.hidden) {
          wasHidden = true;
          console.debug('[live] page hidden');
        } else {
          console.debug('[live] page visible');
          if (wasHidden) {
            // Force refresh when page becomes visible again after being hidden
            console.debug('[live] refreshing after being hidden');
            window.location.reload();
          }
        }
      }

      // Handle window focus/blur (additional mobile support)
      function handleFocus() {
        console.debug('[live] window focused');
        if (wasHidden) {
          console.debug('[live] refreshing after focus');
          window.location.reload();
        }
      }

      function handleBlur() {
        wasHidden = true;
        console.debug('[live] window blurred');
      }

      // Check connection health periodically
      function healthCheck() {
        if (Date.now() - lastActivity > 30000) { // 30 seconds
          console.debug('[live] connection seems stale, reconnecting');
          if (ws) {
            try { ws.close(); } catch (e) {}
          }
          connect();
        }
      }

      // Set up event listeners
      if (typeof document.hidden !== 'undefined') {
        document.addEventListener('visibilitychange', handleVisibilityChange);
      }
      
      window.addEventListener('focus', handleFocus);
      window.addEventListener('blur', handleBlur);
      window.addEventListener('pageshow', function(event) {
        if (event.persisted || wasHidden) {
          console.debug('[live] page shown from cache or after being hidden');
          window.location.reload();
        }
      });

      // Start connection and health check
      connect();
      setInterval(healthCheck, 15000); // Check every 15 seconds
    })();
  </script>
{% endblock %}